{%- capture direction -%}{% render 'direction' %}{%- endcapture -%}
<!doctype html>
<html
  class="no-js{% if request.design_mode %} shopify-design-mode{% endif %}"
  lang="{{ request.locale.iso_code }}"
  dir="{{ direction }}"
>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="{{ settings.color_button_background }}">
    <link rel="canonical" href="{{ canonical_url }}">
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    {% # theme-check-disable RemoteAsset %}
    <link rel="dns-prefetch" href="https://ajax.googleapis.com">
    <link rel="dns-prefetch" href="https://maps.googleapis.com">
    <link rel="dns-prefetch" href="https://maps.gstatic.com">
    {% # theme-check-enable RemoteAsset %}

    {%- if settings.favicon != blank -%}
      <link rel="shortcut icon" href="{{ settings.favicon | image_url: width: 32, height: 32 }}" type="image/png">
    {%- endif -%}

    <title>
      {{- page_title -}}
      {%- if current_tags -%}
        {%- assign meta_tags = current_tags | join: ', ' %} &ndash; {{ 'general.meta.tags' | t: tags: meta_tags -}}
      {%- endif -%}
      {%- if current_page != 1 %} &ndash; {{ 'general.meta.page' | t: page: current_page }}{% endif -%}
      {%- if request.page_type == 'password' -%}
        {{- shop.name -}}
      {%- else -%}
        {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
      {%- endif -%}
    </title>

    {%- if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif -%}

    {%- liquid
      render 'social-meta-tags'

      render 'css-variables'
      echo 'theme.css' | asset_url | stylesheet_tag: preload: true

      if direction == 'rtl'
        echo 'rtl.css' | asset_url | stylesheet_tag: preload: true
      endif
    -%}

    <link
      rel="stylesheet"
      href="{{ 'apps.css' | asset_url }}"
      media="print"
      fetchpriority="low"
      onload="this.media='all'"
    >

    {{ content_for_header }}

    <script src="{{ 'vendor.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'theme.js' | asset_url }}" defer="defer"></script>

    {%- if settings.enable_tab_attention -%}
      <script src="{{ 'tab-attention.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

    {%- if request.page_type contains 'customers/' -%}
      <script src="{{ 'shopify_common.js' | shopify_asset_url }}" defer="defer"></script>
    {%- endif -%}

    {%- render 'js-variables' -%}

    <script>
      if (typeof jQuery == 'undefined') {
        var headTag = document.getElementsByTagName('head')[0];
        var jqTag = document.createElement('script');
        jqTag.type = 'text/javascript';
        jqTag.src = 'https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js';
        jqTag.onload = '';
        headTag.prepend(jqTag);
      }
    </script>
    <script src="//staticxx.s3.amazonaws.com/aio_stats_lib_v1.min.js?v=1.0"></script>
  </head>

  <body
    class="template-{{ template | replace: '.', ' ' | truncatewords: 1, '' | handle }}{% if request.path == '/challenge' %} template-challange{% endif %}"
    data-rounded-button="{{ settings.rounded_button }}"
    data-rounded-input="{{ settings.rounded_input }}"
    data-rounded-block="{{ settings.rounded_block }}"
    data-rounded-card="{{ settings.rounded_card }}"
    data-button-hover="{{ settings.buttons_hover }}"
    {% if settings.enable_page_transition %}
      data-page-transition
    {% endif -%}
    {% if settings.enable_lazy_image %}
      data-lazy-image
    {% endif %}
    data-title-animation
    data-page-rendering
  >
    <a class="sr-only skip-link" href="#MainContent">{{ 'general.accessibility.skip_to_content' | t }}</a>

    {%- liquid
      if settings.enable_page_transition
        render 'loading-bar'
      endif

      render 'mouse-cursor'

      sections 'header-group'
      sections 'overlay-group'
    -%}

    <div class="page-container" id="PageContainer">
      <main class="main-content relative" id="MainContent" role="main">
        {% if template == 'blog' %}
          {% include 'aaa_mem_helper' with 'blog' %}
        {% endif %}
        {% if template == 'collection' %}
          {% include 'aaa_mem_helper' with 'collection' %}
        {% endif %}
        {% if template == 'page' %}
          {% include 'aaa_mem_helper' with 'page' %}
        {% endif %}
        {% if template == 'product' %}
          {% include 'aaa-product-page-filter' %}
        {% endif %}
        {% if template == 'cart' %}
          <script>
            function isMyMembershipScriptLoaded() {
              var url =
                'https://shopifycdn.aaawebstore.com/membership/appfiles/aaa_membership_script_min_v3.js?shop=bathroomtradehub.co.uk';
              var jsFound = 0;
              var scripts = document.getElementsByTagName('script');
              for (var i = scripts.length; i--; ) {
                if (scripts[i].src == url) {
                  jsFound = 1;
                }
              }
              if (!jsFound) {
                var headTag = document.getElementsByTagName('head')[0];
                var jqTag = document.createElement('script');
                jqTag.type = 'text/javascript';
                jqTag.src = url;
                jqTag.onload = '';
                headTag.appendChild(jqTag);
              }
            }
            isMyMembershipScriptLoaded();
          </script>
          <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
          <script>
            // COMPREHENSIVE LOGGING SYSTEM
            window.checkoutDebug = {
              log: function (message, data) {
                console.log('üîç CHECKOUT DEBUG:', message, data || '');
              },
              error: function (message, error) {
                console.error('‚ùå CHECKOUT ERROR:', message, error || '');
              },
              warn: function (message, data) {
                console.warn('‚ö†Ô∏è CHECKOUT WARNING:', message, data || '');
              },
            };

            // Track redirects via monkey-patching (safer approach)
            const originalAssign = window.location.assign;
            const originalReplace = window.location.replace;

            window.location.assign = function (url) {
              checkoutDebug.log('üö® REDIRECT ATTEMPT via location.assign:', url);
              checkoutDebug.log('üîç REDIRECT STACK TRACE:', new Error().stack);
              return originalAssign.call(this, url);
            };

            window.location.replace = function (url) {
              checkoutDebug.log('üö® REDIRECT ATTEMPT via location.replace:', url);
              checkoutDebug.log('üîç REDIRECT STACK TRACE:', new Error().stack);
              return originalReplace.call(this, url);
            };

            // Also monitor direct href assignments (if possible)
            try {
              const originalHref = Object.getOwnPropertyDescriptor(window.location, 'href');
              if (originalHref && originalHref.configurable) {
                Object.defineProperty(window.location, 'href', {
                  set: function (url) {
                    checkoutDebug.log('üö® REDIRECT ATTEMPT via location.href:', url);
                    checkoutDebug.log('üîç REDIRECT STACK TRACE:', new Error().stack);
                    originalHref.set.call(this, url);
                  },
                  get: originalHref.get,
                });
              } else {
                checkoutDebug.log('üìç Cannot monitor location.href (not configurable), monitoring assign/replace only');
              }
            } catch (e) {
              checkoutDebug.log('üìç Cannot monitor location.href:', e.message);
            }

            // Monitor for external redirects on checkout page
            if (window.location.pathname === '/checkout') {
              checkoutDebug.log('üîç CHECKOUT PAGE DETECTED - Monitoring for redirects');

              // Watch for page navigation away from checkout
              window.addEventListener('beforeunload', function (e) {
                checkoutDebug.log('üö® CHECKOUT PAGE LEAVING - beforeunload triggered');
              });

              // Monitor for any setTimeout/setInterval that might redirect
              const originalSetTimeout = window.setTimeout;
              window.setTimeout = function (fn, delay) {
                if (typeof fn === 'string' && fn.includes('location')) {
                  checkoutDebug.log('üö® SUSPICIOUS setTimeout detected:', fn);
                }
                return originalSetTimeout.apply(this, arguments);
              };
            }

            checkoutDebug.log('üîß Checkout monitoring initialized - tracking redirects');
            checkoutDebug.log('üåê Current environment:', {
              isThemeEditor: typeof Shopify !== 'undefined' && Shopify.designMode,
              currentUrl: window.location.href,
              currentPath: window.location.pathname,
              userAgent: navigator.userAgent.substring(0, 100),
            });

            // Critical warning about Theme Editor
            if (typeof Shopify !== 'undefined' && Shopify.designMode) {
              checkoutDebug.warn('‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è THEME EDITOR DETECTED ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è');
              checkoutDebug.warn('üö® CHECKOUT TESTING IN THEME EDITOR IS NOT RELIABLE!');
              checkoutDebug.warn('üö® You must test checkout on the LIVE SITE or a PREVIEW LINK');
              checkoutDebug.warn('üö® Theme editor has different behavior than live checkout');
              checkoutDebug.warn('‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è');
            }

            function aaanewcartmethod() {}
            (function ($) {
              $(document).on('submit', "#cart, form[action='/cart']", function () {
                checkoutDebug.log('üõí CART FORM SUBMITTED - Starting AAA processing');
                checkoutDebug.log('üîç Form details:', {
                  formId: $(this).attr('id'),
                  formAction: $(this).attr('action'),
                  currentUrl: window.location.href,
                  currentPath: window.location.pathname,
                });

                var aaashopurl = 'bathroomtradehub.co.uk';
                var aaamembershipurl = 'https://membership.aaawebstore.com/';
                var note = $('textarea[name=note]').val();

                checkoutDebug.log('‚öôÔ∏è AAA Configuration:', {
                  shopUrl: aaashopurl,
                  membershipUrl: aaamembershipurl,
                  note: note,
                  customerId: $('#aaamembership_customer_logged_id').val(),
                  customerElement: $('#aaamembership_customer_logged_id').length > 0 ? 'Found' : 'NOT FOUND',
                });
                if (note != undefined && note != null) {
                  $.ajax({
                    url: '/cart/update.js',
                    type: 'POST',
                    data: { note: note },
                    success: function (result) {
                      //console.log('cart note = '+result);
                    },
                    error: function (jqxhr, status, exception) {
                      checkoutDebug.error('Cart note update failed:', {
                        status: status,
                        exception: exception,
                        responseText: jqxhr.responseText,
                      });
                    },
                  });
                }

                checkoutDebug.log('üì¶ Fetching cart data from /cart.js...');
                $.ajax({
                  url: '/cart.js',
                  dataType: 'json',
                  timeout: 5000, // Added timeout for cart fetch
                  success: function (cart) {
                    checkoutDebug.log('‚úÖ Cart data received successfully:', {
                      itemCount: cart.items.length,
                      totalPrice: cart.total_price,
                      items: cart.items.map((item) => ({
                        title: item.product_title,
                        variant: item.variant_title,
                        quantity: item.quantity,
                      })),
                    });
                    if (cart.items.length) {
                      var cusId = $('#aaamembership_customer_logged_id').val();
                      var ajax_url = aaamembershipurl + 'memberAjaxFormSubmit.php';
                      var dataform = {
                        formAction: 'generateDraftOrder',
                        customer_id: cusId,
                        domain: aaashopurl,
                        cart: cart,
                      };

                      checkoutDebug.log('üîß Preparing AAA membership request:', {
                        customerId: cusId,
                        ajaxUrl: ajax_url,
                        domain: aaashopurl,
                        cartItems: cart.items.length,
                        requestData: dataform,
                      });
                      checkoutDebug.log('üöÄ Sending AAA membership request...');
                      jQuery.ajax({
                        crossDomain: !0,
                        url: ajax_url,
                        method: 'POST',
                        dataType: 'json',
                        data: dataform,
                        timeout: 10000, // Added 10 second timeout
                        beforeSend: function (xhr) {
                          checkoutDebug.log('üì° AAA AJAX request starting...', {
                            url: ajax_url,
                            method: 'POST',
                            timeout: 10000,
                          });
                        },
                        success: function (response) {
                          checkoutDebug.log('‚úÖ AAA Membership Response received:', {
                            fullResponse: response,
                            status: response.status,
                            redirectUrl: response.redirecturl,
                            message: response.message,
                            errors: response.errors,
                          });

                          if (response.status == 'success') {
                            var redirectUrl = response.redirecturl;
                            checkoutDebug.log('üîç AAA Success - Redirect URL analysis:', {
                              originalUrl: redirectUrl,
                              includesCheckout: redirectUrl ? redirectUrl.includes('/checkout') : false,
                              includesOrders: redirectUrl ? redirectUrl.includes('/orders') : false,
                              isValid:
                                redirectUrl && (redirectUrl.includes('/checkout') || redirectUrl.includes('/orders')),
                            });

                            if (redirectUrl && (redirectUrl.includes('/checkout') || redirectUrl.includes('/orders'))) {
                              checkoutDebug.log('‚úÖ VALID AAA URL - REDIRECTING to:', redirectUrl);
                              checkoutDebug.log('üöÄ EXECUTING REDIRECT NOW...');
                              window.location.href = redirectUrl;
                            } else {
                              checkoutDebug.warn('üö® INVALID AAA REDIRECT URL detected:', redirectUrl);
                              checkoutDebug.log('‚ö†Ô∏è This URL would redirect to homepage - BLOCKING IT');
                              checkoutDebug.log('‚úÖ REDIRECTING to standard checkout instead');
                              checkoutDebug.log('üöÄ EXECUTING REDIRECT NOW...');
                              window.location.href = '/checkout';
                            }
                          } else {
                            checkoutDebug.log('‚ùå AAA service returned error status:', response.status);
                            checkoutDebug.log('‚úÖ REDIRECTING to standard checkout');
                            checkoutDebug.log('üöÄ EXECUTING REDIRECT NOW...');
                            window.location.href = '/checkout';
                          }
                        },
                        error: function (jqxhr, status, exception) {
                          checkoutDebug.error('AAA Membership service error:', {
                            status: status,
                            exception: exception,
                            responseText: jqxhr.responseText,
                            statusCode: jqxhr.status,
                            readyState: jqxhr.readyState,
                          });
                          checkoutDebug.log('‚úÖ REDIRECTING to standard checkout due to AAA error');
                          checkoutDebug.log('üöÄ EXECUTING REDIRECT NOW...');
                          window.location.href = '/checkout';
                        },
                      });
                    } else {
                      checkoutDebug.log('üõí Cart is empty, reloading page');
                      location.reload();
                    }
                  },
                  error: function (jqxhr, status, exception) {
                    checkoutDebug.error('Cart fetch error:', {
                      status: status,
                      exception: exception,
                      responseText: jqxhr.responseText,
                    });
                    checkoutDebug.log('‚úÖ REDIRECTING to checkout due to cart fetch error');
                    checkoutDebug.log('üöÄ EXECUTING REDIRECT NOW...');
                    window.location.href = '/checkout';
                  },
                });
                checkoutDebug.log('üîÑ Returning false to prevent default form submission');
                return false;
              });
            })(jQuery);
          </script>
        {% endif %}

        {{ content_for_layout }}
      </main>

      <footer class="footer-group block w-full" is="footer-group">
        {%- sections 'footer-group' -%}
      </footer>
    </div>

    <ul hidden>
      <li id="a11y-refresh-page-message">{{ 'general.accessibility.refresh_page' | t }}</li>
      <li id="a11y-new-window-message">{{ 'general.accessibility.link_messages.new_window' | t }}</li>
    </ul>

    {%- if request.design_mode == false and settings.preload_links -%}
      <script src="{{ 'instant-page.js' | asset_url }}" type="module" fetchpriority="low" defer="defer"></script>
    {%- endif -%}

    {% if customer %}
      <div class="aaa_customer_id" hidden>{{ customer.id }}</div>
    {% endif -%}
    <input
      type="hidden"
      id="656565115116111114101"
      data-customer-id="{{ customer.id }}"
      data-customer-email="{{ customer.email }}"
      data-customer-name="{{ customer.first_name }} {{ customer.last_name }}"

    ><input
      type="hidden"
      name="aaamembership_customer_logged_id"
      value="{{customer.id}}"
      id="aaamembership_customer_logged_id"
    >
  </body>
</html>
