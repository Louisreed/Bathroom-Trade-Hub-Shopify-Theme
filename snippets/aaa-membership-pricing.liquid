{%- comment -%}
  AAA Membership Pricing Helper

  Calculates membership discount percentage for the current customer based on shop metafields.
  Sets membership_discount_percent variable that can be used by product-price snippet.

  Usage: {% render 'aaa-membership-pricing' %}
{%- endcomment -%}

{%- liquid
  assign membership_discount_percent = 0
  assign has_membership_pricing = false

  # Include price rules to check for membership pricing
  render 'aaa-plan_rule'

  # Check if customer has membership pricing access
  unless aaa_price_hide_item == true
    # First try aaa_mem_price (original format)
    for aaa_rule in shop.metafields.aaa_mem_price
      assign key_wrd = aaa_rule.last | split: ','

      # Check if this customer's tags match the membership rule
      for customer_tag in customer.tags
        assign clean_customer_tag = customer_tag | downcase | strip
        assign clean_rule_tag = key_wrd.first | downcase | strip

        if clean_customer_tag == clean_rule_tag
          # Extract discount percentage (e.g., "50%" -> 50)
          if key_wrd.size > 2
            assign discount_string = key_wrd[2] | remove: '%' | strip
            assign membership_discount_percent = discount_string | plus: 0
            assign has_membership_pricing = true
            break
          endif
        endif
      endfor

      if has_membership_pricing
        break
      endif
    endfor

    # If no discount found, try AtTrillion membership metafields
    unless has_membership_pricing
      for membership_rule in shop.metafields.membership
        assign rule_parts = membership_rule.last | split: ','

        for customer_tag in customer.tags
          assign clean_customer_tag = customer_tag | downcase | strip
          assign clean_rule_tag = rule_parts.first | downcase | strip

          if clean_customer_tag == clean_rule_tag
            if rule_parts.size > 2
              assign discount_string = rule_parts[2] | remove: '%' | strip
              assign membership_discount_percent = discount_string | plus: 0
              assign has_membership_pricing = true
              break
            endif
          endif
        endfor

        if has_membership_pricing
          break
        endif
      endfor
    endunless

    # If still no discount, try AtTrillion atrillion metafields
    unless has_membership_pricing
      for atrillion_rule in shop.metafields.atrillion
        assign rule_parts = atrillion_rule.last | split: ','

        for customer_tag in customer.tags
          assign clean_customer_tag = customer_tag | downcase | strip
          assign clean_rule_tag = rule_parts.first | downcase | strip

          if clean_customer_tag == clean_rule_tag
            if rule_parts.size > 2
              assign discount_string = rule_parts[2] | remove: '%' | strip
              assign membership_discount_percent = discount_string | plus: 0
              assign has_membership_pricing = true
              break
            endif
          endif
        endfor

        if has_membership_pricing
          break
        endif
      endfor
    endunless

    # FALLBACK: If customer has hubpro-free tag, apply 50% discount
    unless has_membership_pricing
      for customer_tag in customer.tags
        assign clean_customer_tag = customer_tag | downcase | strip
        if clean_customer_tag == 'hubpro-free'
          assign membership_discount_percent = 50
          assign has_membership_pricing = true
          break
        endif
      endfor
    endunless
  endunless
-%}

{%- comment -%} COMPREHENSIVE DEBUG for AAA membership pricing {%- endcomment -%}
<script>
  if (window.console && window.console.log) {
    console.log('üöÄ === AAA MEMBERSHIP PRICING DEBUG START ===');
    console.log('üë§ CUSTOMER STATUS:', {
      loggedIn: {% if customer %}true{% else %}false{% endif %},
      customerId: {% if customer.id %}{{ customer.id | json }}{% else %}null{% endif %},
      customerEmail: {% if customer.email %}{{ customer.email | json }}{% else %}null{% endif %},
      customerName: '{% if customer %}{{ customer.first_name }} {{ customer.last_name }}{% else %}Not logged in{% endif %}',
      customerTags: {% if customer.tags %}{{ customer.tags | json }}{% else %}[]{% endif %},
      totalTags: {% if customer.tags %}{{ customer.tags.size }}{% else %}0{% endif %}
    });

    console.log('üè™ SHOP METAFIELDS (aaa_mem_price):');
    {% if shop.metafields.aaa_mem_price.size > 0 %}
      {% for aaa_rule in shop.metafields.aaa_mem_price %}
        console.log('  Rule {{ forloop.index }}: "{{ aaa_rule.first }}" = "{{ aaa_rule.last }}"');
        console.log('    Split parts:', '{{ aaa_rule.last }}'.split(','));
      {% endfor %}
    {% else %}
      console.log('  ‚ùå NO AAA PRICING METAFIELDS FOUND!');
    {% endif %}

    console.log('üîç DEBUGGING ALL SHOP METAFIELDS:');
    {% for metafield in shop.metafields %}
      console.log('  Found metafield: {{ metafield.namespace }}.{{ metafield.key }} = {{ metafield.value }}');
    {% endfor %}

    console.log('üéØ CHECKING ATRILLION/MEMBERSHIP NAMESPACES:');
    {% if shop.metafields.membership %}
      console.log('  ‚úÖ shop.metafields.membership exists');
      {% for rule in shop.metafields.membership %}
        console.log('    Membership rule: "{{ rule.first }}" = "{{ rule.last }}"');
        console.log('    Split parts:', '{{ rule.last }}'.split(','));
      {% endfor %}
    {% else %}
      console.log('  ‚ùå shop.metafields.membership not found');
    {% endif %}
    {% if shop.metafields.atrillion %}
      console.log('  ‚úÖ shop.metafields.atrillion exists');
      {% for rule in shop.metafields.atrillion %}
        console.log('    AtTrillion rule: "{{ rule.first }}" = "{{ rule.last }}"');
        console.log('    Split parts:', '{{ rule.last }}'.split(','));
      {% endfor %}
    {% else %}
      console.log('  ‚ùå shop.metafields.atrillion not found');
    {% endif %}

    console.log('üîÑ PROCESSING ATRILLION TAG MATCHING:');
    {% for customer_tag in customer.tags %}
      console.log('  üè∑Ô∏è Testing customer tag: "{{ customer_tag }}"');
      {% for membership_rule in shop.metafields.membership %}
        {% assign rule_parts = membership_rule.last | split: ',' %}
        {% assign rule_tag = rule_parts.first | downcase | strip %}
        console.log('    vs membership rule tag: "{{ rule_tag }}"');
        {% if customer_tag == rule_tag %}
          console.log('      ‚úÖ MATCH! Rule: {{ membership_rule.last }}');
        {% endif %}
      {% endfor %}
      {% for atrillion_rule in shop.metafields.atrillion %}
        {% assign rule_parts = atrillion_rule.last | split: ',' %}
        {% assign rule_tag = rule_parts.first | downcase | strip %}
        console.log('    vs atrillion rule tag: "{{ rule_tag }}"');
        {% if customer_tag == rule_tag %}
          console.log('      ‚úÖ MATCH! Rule: {{ atrillion_rule.last }}');
        {% endif %}
      {% endfor %}
    {% endfor %}

    console.log('üîç TAG MATCHING PROCESS:');
    {% if customer.tags.size > 0 %}
      {% for customer_tag in customer.tags %}
        console.log('  üè∑Ô∏è Customer Tag {{ forloop.index }}: "{{ customer_tag }}"');
        {% for aaa_rule in shop.metafields.aaa_mem_price %}
          {% assign key_wrd = aaa_rule.last | split: ',' %}
          {% assign clean_customer_tag = customer_tag | downcase | strip %}
          {% assign clean_rule_tag = key_wrd.first | downcase | strip %}
          console.log('    Comparing "{{ clean_customer_tag }}" vs "{{ clean_rule_tag }}"');
          {% if clean_customer_tag == clean_rule_tag %}
            console.log('    ‚úÖ MATCH FOUND! Rule: {{ aaa_rule.last }}');
            {% if key_wrd.size > 2 %}
              console.log('    üí∞ Discount: {{ key_wrd[2] }}');
            {% else %}
              console.log('    ‚ùå No discount percentage found in rule');
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endfor %}
    {% else %}
      console.log('  ‚ùå Customer has NO TAGS!');
    {% endif %}

    console.log('üìä FINAL CALCULATION RESULT:', {
      priceHideItem: {% if aaa_price_hide_item %}{{ aaa_price_hide_item }}{% else %}false{% endif %},
      membershipDiscountPercent: {% if membership_discount_percent %}{{ membership_discount_percent }}{% else %}0{% endif %},
      hasMembershipPricing: {% if has_membership_pricing %}{{ has_membership_pricing }}{% else %}false{% endif %},
      discountWillApply: {% if membership_discount_percent > 0 %}true{% else %}false{% endif %}
    });

    {% if membership_discount_percent > 0 %}
      console.log('üéØ ‚úÖ DISCOUNT SHOULD BE APPLIED!');
    {% else %}
      console.log('‚ùå NO DISCOUNT - Check customer login, tags, or shop configuration');
    {% endif %}

    console.log('üöÄ === AAA MEMBERSHIP PRICING DEBUG END ===');
  }
</script>
